___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "TrustArc CMP (Consent Mode)",
  "brand": {
    "id": "brand_dummy",
    "displayName": "",
    "thumbnail": "data:image/jpeg;base64,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\u003d"
  },
  "description": "TrustArc CMP communicates consent choices to Google using Consent Mode as an alternate to blocking tags and improving Analytics or Advertising tracking while adhering to regulations like the GDPR.",
  "containerContexts": [
    "WEB"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "GROUP",
    "name": "consentTypes",
    "displayName": "Consent Types",
    "groupStyle": "ZIPPY_OPEN",
    "subParams": [
      {
        "type": "TEXT",
        "name": "adPersonalizationId",
        "displayName": "ad_personalization",
        "simpleValueType": true,
        "valueValidators": [
          {
            "type": "NON_NEGATIVE_NUMBER"
          }
        ]
      },
      {
        "type": "TEXT",
        "name": "adStorageId",
        "displayName": "ad_storage",
        "simpleValueType": true,
        "valueValidators": [
          {
            "type": "NON_NEGATIVE_NUMBER"
          }
        ]
      },
      {
        "type": "TEXT",
        "name": "adUserDataId",
        "displayName": "ad_user_data",
        "simpleValueType": true,
        "valueValidators": [
          {
            "type": "NON_NEGATIVE_NUMBER"
          }
        ]
      },
      {
        "type": "TEXT",
        "name": "analyticsStorageId",
        "displayName": "analytics_storage",
        "simpleValueType": true,
        "valueValidators": [
          {
            "type": "NON_NEGATIVE_NUMBER"
          }
        ]
      },
      {
        "type": "TEXT",
        "name": "functionalityStorageId",
        "displayName": "functionality_storage",
        "simpleValueType": true,
        "valueValidators": [
          {
            "type": "NON_NEGATIVE_NUMBER"
          }
        ]
      },
      {
        "type": "TEXT",
        "name": "personalizationStorageId",
        "displayName": "personalization_storage",
        "simpleValueType": true,
        "valueValidators": [
          {
            "type": "NON_NEGATIVE_NUMBER"
          }
        ]
      },
      {
        "type": "TEXT",
        "name": "securityStorageId",
        "displayName": "security_storage",
        "simpleValueType": true,
        "valueValidators": [
          {
            "type": "NON_NEGATIVE_NUMBER"
          }
        ]
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "settings",
    "displayName": "Settings",
    "groupStyle": "ZIPPY_OPEN",
    "subParams": [
      {
        "type": "CHECKBOX",
        "name": "enableAdsRedacted",
        "checkboxText": "Redact Ads data",
        "simpleValueType": true
      },
      {
        "type": "CHECKBOX",
        "name": "enableUrlPassthrough",
        "checkboxText": "Enable URL Passthrough",
        "simpleValueType": true
      }
    ]
  },
  {
    "type": "SELECT",
    "name": "prefCookie",
    "displayName": "Preferences Cookie",
    "macrosInSelect": true,
    "selectItems": [],
    "simpleValueType": true,
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ]
  },
  {
    "type": "SELECT",
    "name": "behaviorCookie",
    "displayName": "Behavior Cookie",
    "macrosInSelect": true,
    "selectItems": [],
    "simpleValueType": true,
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ]
  }
]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

// required funcs
const log = require('logToConsole');
const setDefaultConsentState = require('setDefaultConsentState');
const gtagSet = require('gtagSet');

const ConsentType = {
    DENIED: 'denied',
    GRANTED: 'granted'
};

let adStorage, analyticsStorage, adPersonalization, adUserData, functionalityStorage, personalizationStorage, securityStorage;

adStorage = analyticsStorage = adPersonalization = adUserData = functionalityStorage = personalizationStorage = securityStorage = false;

gtagSet({
  'developer_id.dNTIxZG': true,
  'ads_data_redaction': data.enableAdsRedacted,
  'url_passthrough': data.enableUrlPassthrough
});
log("ads_data_redaction: " + data.enableAdsRedacted);
log("url_passthrough: " + data.enableUrlPassthrough);
log("prefCookie: " + data.prefCookie);


// no existing consent
if (!data.prefCookie) {
  log("behaviorCookie: " + data.behaviorCookie);
  // us: grant by default, eu: deny by default
  if (data.behaviorCookie && data.behaviorCookie.indexOf('us') > -1) {
    adStorage = analyticsStorage = adPersonalization = adUserData = functionalityStorage =                 personalizationStorage = securityStorage = true;
  }
} else { // has existing consent, fetch via mapped
  log("adPersonalizationId: " + data.adPersonalizationId);
  if (data.adPersonalizationId > -1) {
    adPersonalization = data.prefCookie.indexOf(data.adPersonalizationId) > -1;
  }
  log("adStorageId: " + data.adStorageId);
  if (data.adStorageId > -1) {
    adStorage = data.prefCookie.indexOf(data.adStorageId) > -1;
  }
  log("adUserDataId: " + data.adUserDataId);
  if (data.adUserDataId > -1) {
    adUserData = data.prefCookie.indexOf(data.adUserDataId) > -1;
  }
  log("analyticsStorageId: " + data.analyticsStorageId);
  if (data.analyticsStorageId > -1) {
    analyticsStorage = data.prefCookie.indexOf(data.analyticsStorageId) > -1;
  }
  log("functionalityStorageId: " + data.functionalityStorageId);
  if (data.functionalityStorageId > -1) {
    functionalityStorage = data.prefCookie.indexOf(data.functionalityStorageId) > -1;
  }
  log("personalizationStorageId: " + data.personalizationStorageId);
  if (data.personalizationStorageId > -1) {
    personalizationStorage = data.prefCookie.indexOf(data.personalizationStorageId) > -1;
  }
  log("securityStorageId: " + data.securityStorageId);
  if (data.securityStorageId > -1) {
    securityStorage = data.prefCookie.indexOf(data.securityStorageId) > -1;
  }
}


setDefaultConsentState({
    'ad_personalization': adPersonalization ? ConsentType.GRANTED : ConsentType.DENIED,
    'ad_storage': adStorage ? ConsentType.GRANTED : ConsentType.DENIED,
    'ad_user_data': adUserData ? ConsentType.GRANTED : ConsentType.DENIED,
    'analytics_storage': analyticsStorage ? ConsentType.GRANTED : ConsentType.DENIED,
    'functionality_storage': functionalityStorage ? ConsentType.GRANTED : ConsentType.DENIED,
    'personalization_storage': personalizationStorage ? ConsentType.GRANTED : ConsentType.DENIED,
    'security_storage': securityStorage ? ConsentType.GRANTED : ConsentType.DENIED,
    'wait_for_update': 500
});


// Call data.gtmOnSuccess when the tag is finished.
data.gtmOnSuccess();


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "debug"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_consent",
        "versionId": "1"
      },
      "param": [
        {
          "key": "consentTypes",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "ad_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "analytics_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "functionality_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "personalization_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "security_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "ad_personalization"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "ad_user_data"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "write_data_layer",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keyPatterns",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "developer_id.dNTIxZG"
              },
              {
                "type": 1,
                "string": "ads_data_redaction"
              },
              {
                "type": 1,
                "string": "url_passthrough"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios: []


___NOTES___

Created on 12/15/2023, 1:57:22 PM


